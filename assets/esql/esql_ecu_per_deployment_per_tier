FROM monitoring-indices
| WHERE @timestamp < now()
| EVAL 
    @timestamp = DATE_TRUNC(1 day, @timestamp),
    composite_key = CONCAT(DATE_FORMAT("yyyy-MM-dd", @timestamp), "_", elasticsearch.cluster.name),
    composite_tier_key = CONCAT(composite_key, "_", REPLACE(elasticsearch.index.tier, "/", "_"))
| STATS 
    sum_query_time_local = sum(elasticsearch.index.total.search.query_time_in_millis), 
    sum_indexing_time_local = sum(elasticsearch.index.total.indexing.index_time_in_millis),
    sum_data_set_store_size_local = sum(elasticsearch.index.primaries.store.total_data_set_size_in_bytes),
    sum_store_size_local = sum(elasticsearch.index.total.store.size_in_bytes)
  BY 
    @timestamp,
    composite_key,
    composite_tier_key,
    elasticsearch.cluster.name,
    elasticsearch.index.tier
| LOOKUP JOIN billing_cluster_cost_lookup ON composite_key
| WHERE total_ecu > 0
| LOOKUP JOIN cluster_deployment_contribution_lookup on composite_key 
| LOOKUP JOIN cluster_deployment_contribution_lookup on composite_tier_key
| WHERE elasticsearch.index.tier != tier
| EVAL 
    query_portion = sum_query_time_local / (sum_query_time_local + sum_query_time) * total_ecu,
    indexing_portion = sum_indexing_time_local / (sum_indexing_time_local + sum_indexing_time) * total_ecu,
    store_portion = sum_store_size_local / (sum_store_size_local + sum_store_size) * total_ecu,
    data_store_portion = sum_data_set_store_size_local / (sum_data_set_store_size_local + sum_data_set_store_size) * total_ecu,
    storage_weight = 40,
    query_weight = 20,
    index_weight = 20,
    total_weight_hot = storage_weight + query_weight + index_weight,
    total_weight_cold = storage_weight + query_weight,
    ece_portion = CASE (
            elasticsearch.index.tier == "hot/content", 
            (query_portion * query_weight + indexing_portion * index_weight + store_portion * storage_weight) / total_weight_hot, 
            (query_portion * query_weight + store_portion * storage_weight) / total_weight_cold)
//| KEEP
//    @timestamp, 
//    elasticsearch.cluster.name, 
//    deployment_name, 
//    elasticsearch.index.tier, 
//    ece_portion
| STATS 
    total_ece_portion = sum(ece_portion)
  BY 
    elasticsearch.cluster.name, 
    deployment_name, 
    elasticsearch.index.tier
| KEEP
    elasticsearch.cluster.name, 
    deployment_name, 
    elasticsearch.index.tier, 
    total_ece_portion