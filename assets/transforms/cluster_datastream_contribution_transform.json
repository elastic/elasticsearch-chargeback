PUT _transform/cluster_datastream_contribution_transform
{
  "description": "Aggregates daily total ECU usage per DATASTREAM from billing metrics, using ingested timestamps with a 1-hour sync delay and running every 60 minutes.",
  "source": {
    "index": [
      "monitoring-indices"
    ],
    "query": {
      "match_all": {}
    }
  },
  "dest": {
    "index": "cluster_datastream_contribution_lookup",
    "pipeline": "set_consumption_composite_key"
  },
  "frequency": "60m",
  "sync": {
    "time": {
      "field": "event.ingested",
      "delay": "1h"
    }
  },
  "pivot": {
    "group_by": {
      "@timestamp": {
        "date_histogram": {
          "field": "@timestamp",
          "calendar_interval": "1d"
        }
      },
      "cluster_name": {
        "terms": {
          "field": "elasticsearch.cluster.name"
        }
      },
      "datastream": {
        "terms": {
          "field": "elasticsearch.index.datastream"
        }
      }
    },
    "aggregations": {
      "datastream_sum_indexing_time": {
        "sum": {
          "field": "elasticsearch.index.total.indexing.index_time_in_millis"
        }
      },
      "datastream_sum_query_time": {
        "sum": {
          "field": "elasticsearch.index.total.search.query_time_in_millis"
        }
      },
      "datastream_sum_store_size": {
        "sum": {
          "field": "elasticsearch.index.total.store.size_in_bytes"
        }
      },
      "datastream_sum_data_set_store_size": {
        "sum": {
          "field": "elasticsearch.index.primaries.store.total_data_set_size_in_bytes"
        }
      }
    }
  }
}