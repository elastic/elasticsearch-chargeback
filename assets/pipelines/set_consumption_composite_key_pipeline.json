PUT _ingest/pipeline/set_consumption_composite_key
{
  "description": "Consumption Transform: Set all the possible correlation keys. To be used in consumption transforms.",
  "processors": [
    {
      "script": {
        "lang": "painless",
        "source": """
          if (ctx.cluster_name != null) {
            ctx.deployment_id = ctx.cluster_name;
          }
          if (ctx['@timestamp'] != null) {
            ctx.composite_key = ZonedDateTime.parse(ctx['@timestamp']).toLocalDate().toString() + '_' + ctx.deployment_id;
            if (ctx.tier != null) ctx.composite_tier_key = ctx.composite_key + '_' + ctx.tier.replace('/', '_');
            if (ctx.datastream != null) ctx.composite_datastream_key = ctx.composite_key + '_' + ctx.datastream;
          }
        """
      }
    }
  ]
}