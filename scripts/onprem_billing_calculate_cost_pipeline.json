{
  "description": "On-Prem Billing: Computes mERU from ERU or RAM config and maps to ESS Billing schema (matches integrations wip/onprem-billing-integration)",
  "processors": [
    {
      "set": {
        "field": "_org_lookup",
        "value": "organization",
        "description": "Set lookup key for org config"
      }
    },
    {
      "enrich": {
        "policy_name": "onprem_billing_org_config_policy",
        "field": "_org_lookup",
        "target_field": "org_config",
        "max_matches": 1,
        "ignore_missing": true,
        "ignore_failure": true
      }
    },
    {
      "enrich": {
        "policy_name": "onprem_billing_config_enrich_policy",
        "field": "cluster_uuid",
        "target_field": "cost_config",
        "max_matches": 1,
        "ignore_missing": true,
        "ignore_failure": true
      }
    },
    {
      "script": {
        "lang": "painless",
        "ignore_failure": true,
        "description": "Compute mERU from ERU or RAM config and map to ESS Billing schema",
        "source": "String deploymentId = ctx.cluster_uuid; String deploymentName = ctx.cluster_name; long dailyMeru = 1000L; List deploymentTags = new ArrayList(); int eruToRamGb = 64; if (ctx.org_config != null && ctx.org_config.eru_to_ram_gb != null) { eruToRamGb = (int) ctx.org_config.eru_to_ram_gb; } if (ctx.cost_config != null) { if (ctx.cost_config.deployment_name != null) { deploymentName = ctx.cost_config.deployment_name; } Object rawTags = ctx.cost_config.deployment_tags; if (rawTags != null) { if (rawTags instanceof List) { deploymentTags = (List) rawTags; } else { deploymentTags.add(rawTags.toString()); } } if (ctx.cost_config.daily_meru != null) { dailyMeru = (long) ctx.cost_config.daily_meru; } else if (ctx.cost_config.deployment_erus != null) { dailyMeru = (long) (ctx.cost_config.deployment_erus * 1000.0); } else if (ctx.cost_config.node_count != null && ctx.cost_config.ram_per_node_gb != null) { int totalRamGb = (int) ctx.cost_config.node_count * (int) ctx.cost_config.ram_per_node_gb; dailyMeru = (long) ((double) totalRamGb / (double) eruToRamGb * 1000.0); } } if (ctx.ess == null) ctx.ess = new HashMap(); if (ctx.ess.billing == null) ctx.ess.billing = new HashMap(); ctx.ess.billing.deployment_id = deploymentId; ctx.ess.billing.deployment_name = deploymentName; ctx.ess.billing.deployment_type = 'onprem'; ctx.ess.billing.deployment_tags = deploymentTags != null ? deploymentTags : new ArrayList(); ctx.ess.billing.kind = 'elasticsearch'; ctx.ess.billing.type = 'capacity'; ctx.ess.billing.unit = 'day'; ctx.ess.billing.zone_count = 1; ctx.ess.billing.name = 'On-Premises: ' + deploymentName; ctx.ess.billing.sku = 'onprem_node'; if (ctx['@timestamp'] != null) { ctx.ess.billing.from = ctx['@timestamp']; String ts = ctx['@timestamp'].toString(); if (ts.length() >= 10) { ctx.ess.billing.to = ts.substring(0, 10) + 'T23:59:59.999Z'; } } ctx.ess.billing.total_ecu = dailyMeru; ctx.ess.billing.put('quantity.value', 1.0); ctx.ess.billing.put('quantity.formatted_value', '1 day'); ctx.ess.billing.put('display_quantity.value', 1.0); ctx.ess.billing.put('display_quantity.formatted_value', '1 day'); ctx.ess.billing.put('display_quantity.type', 'default'); ctx.remove('cluster_uuid'); ctx.remove('cluster_name'); ctx.remove('cost_config'); ctx.remove('org_config'); ctx.remove('_org_lookup'); ctx.remove('doc_count');"
      }
    },
    {
      "pipeline": {
        "description": "[Fleet] Global pipeline for all data streams",
        "ignore_missing_pipeline": true,
        "name": "global@custom"
      }
    },
    {
      "pipeline": {
        "description": "[Fleet] Pipeline for all data streams of type metrics",
        "ignore_missing_pipeline": true,
        "name": "metrics@custom"
      }
    }
  ]
}
